{% extends "base.html" %}

{% block title %}Database Snapshots - NukeWorks{% endblock %}

{% macro human_size(num_bytes) %}
    {% set scaled = num_bytes or 0 %}
    {% if scaled >= 1024 * 1024 * 1024 %}
        {{ (scaled / (1024 * 1024 * 1024))|round(2) }} GB
    {% elif scaled >= 1024 * 1024 %}
        {{ (scaled / (1024 * 1024))|round(2) }} MB
    {% elif scaled >= 1024 %}
        {{ (scaled / 1024)|round(2) }} KB
    {% else %}
        {{ scaled }} B
    {% endif %}
{% endmacro %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Database Snapshots</h1>
        <p class="text-muted mb-0">Create manual backups, review automated runs, and restore when needed.</p>
    </div>
    <div>
        <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Admin</a>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Total Snapshots</div>
                <div class="h4 mb-0">{{ stats.total }}</div>
                <div class="small text-muted">Manual: {{ stats.manual }} | Automated: {{ stats.automated }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Disk Usage</div>
                <div class="h4 mb-0">{{ human_size(stats.disk_usage_bytes) }}</div>
                <div class="small text-muted">Retained: {{ stats.retained }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Next Automated Run</div>
                {% if schedule_enabled %}
                    <div class="h6 mb-0">{{ next_run.strftime('%b %d, %Y %H:%M') }}</div>
                    {% if schedule_overdue %}
                        <div class="small text-danger">Overdue &mdash; will run soon</div>
                    {% else %}
                        <div class="small text-muted">Server time</div>
                    {% endif %}
                {% else %}
                    <div class="h6 mb-0 text-muted">Disabled</div>
                    <div class="small text-muted">Enable in System Settings</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted text-uppercase small">Last Snapshot</div>
                {% if last_snapshot %}
                    <div class="h6 mb-0">{{ last_snapshot.snapshot_timestamp.strftime('%b %d, %Y %H:%M') }}</div>
                    <div class="small text-muted">{{ (last_snapshot.snapshot_type or 'Unknown').replace('_', ' ').title() }}</div>
                {% else %}
                    <div class="h6 mb-0 text-muted">No snapshots yet</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Create Manual Snapshot</h5>
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('admin.create_manual_snapshot') }}" novalidate>
            {{ manual_form.hidden_tag() }}
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Description (optional)</label>
                    {{ manual_form.description(class="form-control", placeholder="Label to identify this snapshot") }}
                    {% for error in manual_form.description.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-md-3">
                    <div class="form-check mt-4">
                        {{ manual_form.retain(class="form-check-input", id="retainSnapshot") }}
                        <label class="form-check-label" for="retainSnapshot">Retain (skip auto-cleanup)</label>
                    </div>
                </div>
                <div class="col-md-3 text-md-end">
                    {{ manual_form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Automated Snapshot Schedule</h5>
        <a href="{{ url_for('admin.system_settings', section='backups') }}" class="btn btn-outline-primary btn-sm">Backup Settings</a>
    </div>
    <div class="card-body">
        {% if schedule_enabled %}
            <p class="mb-1"><strong>Status:</strong> Enabled</p>
            <p class="mb-1"><strong>Next Run:</strong> {{ next_run.strftime('%A, %b %d at %H:%M') }} (server time)</p>
            {% if stats.last_automated %}
                <p class="mb-0"><strong>Last Automated Snapshot:</strong> {{ stats.last_automated.snapshot_timestamp.strftime('%b %d, %Y %H:%M') }} &middot; {{ human_size(stats.last_automated.snapshot_size_bytes) }}</p>
            {% else %}
                <p class="mb-0 text-muted">No automated snapshots recorded yet.</p>
            {% endif %}
            {% if schedule_overdue %}
                <p class="mb-0 text-danger">Automated snapshot is overdue and will execute shortly.</p>
            {% endif %}
        {% else %}
            <p class="mb-0">Automated snapshots are currently disabled. Enable them in System Settings &rarr; Backups.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Snapshot History</h5>
    </div>
    <div class="card-body p-0">
        {% if snapshots %}
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Timestamp</th>
                            <th scope="col">Type</th>
                            <th scope="col">Description</th>
                            <th scope="col">Size</th>
                            <th scope="col">Retained</th>
                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for snapshot in snapshots %}
                        <tr>
                            <td>{{ snapshot.snapshot_timestamp.strftime('%b %d, %Y %H:%M:%S') }}</td>
                            <td>{{ (snapshot.snapshot_type or 'Unknown').replace('_', ' ').title() }}</td>
                            <td>{{ snapshot.description or 'â€”' }}</td>
                            <td>{{ human_size(snapshot.snapshot_size_bytes) }}</td>
                            <td>
                                {% if snapshot.is_retained %}
                                    <span class="badge bg-success">Retained</span>
                                {% elif (snapshot.snapshot_type or '').upper().startswith('AUTOMATED') %}
                                    <span class="badge bg-info text-dark">Automated</span>
                                {% else %}
                                    <span class="text-muted">No</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#restoreModal{{ snapshot.snapshot_id }}">
                                    <i class="bi bi-cloud-download"></i> Restore
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="p-4 text-center text-muted">
                <i class="bi bi-hdd-network fs-1 d-block mb-2"></i>
                <p class="mb-0">No snapshots found. Create a manual snapshot or enable automated scheduling.</p>
            </div>
        {% endif %}
    </div>
</div>

{% for snapshot in snapshots %}
<div class="modal fade" id="restoreModal{{ snapshot.snapshot_id }}" tabindex="-1" aria-labelledby="restoreModalLabel{{ snapshot.snapshot_id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreModalLabel{{ snapshot.snapshot_id }}">Restore Snapshot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Restoring will replace the current database with the snapshot taken on <strong>{{ snapshot.snapshot_timestamp.strftime('%b %d, %Y %H:%M:%S') }}</strong>.</p>
                <p class="mb-0">A backup of the current database will be saved before restoring so you can revert if needed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{{ url_for('admin.restore_snapshot_view', snapshot_id=snapshot.snapshot_id) }}">
                    {{ restore_forms[snapshot.snapshot_id].hidden_tag() }}
                    {{ restore_forms[snapshot.snapshot_id].snapshot_id(value=snapshot.snapshot_id) }}
                    {{ restore_forms[snapshot.snapshot_id].submit(class="btn btn-danger", value="Restore Snapshot") }}
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}
