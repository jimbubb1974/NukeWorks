{% extends "base.html" %}

{% block title %}Audit Log - NukeWorks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Audit Log</h1>
        <p class="text-muted mb-0">Review all create, update, and delete activity across the system.</p>
    </div>
    <div>
        <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Admin</a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Action</label>
                <select name="action" class="form-select">
                    <option value="">All Actions</option>
                    {% for action in actions %}
                        <option value="{{ action }}" {% if filters.action == action %}selected{% endif %}>{{ action.title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Table</label>
                <select name="table" class="form-select">
                    <option value="">All Tables</option>
                    {% for table in table_options %}
                        <option value="{{ table }}" {% if filters.table == table %}selected{% endif %}>{{ table }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">User</label>
                <select name="user" class="form-select">
                    <option value="">All Users</option>
                    {% for user in user_options %}
                        <option value="{{ user.user_id }}" {% if filters.user == user.user_id %}selected{% endif %}>
                            {{ user.full_name or user.username }} ({{ user.username }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" name="search" value="{{ filters.search }}" class="form-control" placeholder="Field, value, or keyword">
            </div>
            <div class="col-md-2">
                <label class="form-label">Results Per Page</label>
                <select name="per_page" class="form-select">
                    {% for option in [25, 50, 100, 200] %}
                        <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Start</label>
                <input type="text" name="start" value="{{ filters.start }}" class="form-control" placeholder="YYYY-MM-DD[ HH:MM]">
            </div>
            <div class="col-md-2">
                <label class="form-label">End</label>
                <input type="text" name="end" value="{{ filters.end }}" class="form-control" placeholder="YYYY-MM-DD[ HH:MM]">
            </div>
            <div class="col-md-2 ms-auto text-end">
                <button type="submit" class="btn btn-primary"><i class="bi bi-filter"></i> Apply Filters</button>
            </div>
        </form>
    </div>
</div>

<div class="row g-3 mb-3">
    {% for action, total in action_totals.items() %}
    <div class="col-md-2">
        <div class="card h-100 border-secondary">
            <div class="card-body py-3">
                <div class="text-muted text-uppercase small">{{ action.title() }}</div>
                <div class="h5 mb-0">{{ total }}</div>
            </div>
        </div>
    </div>
    {% endfor %}
    <div class="col-md-2">
        <div class="card h-100 border-secondary">
            <div class="card-body py-3">
                <div class="text-muted text-uppercase small">Page</div>
                <div class="h5 mb-0">{{ summary.page }}</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Audit Entries</h5>
        <span class="text-muted small">Showing {{ summary.count }} item(s)</span>
    </div>
    <div class="card-body p-0">
        {% if entries %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Timestamp</th>
                            <th scope="col">User</th>
                            <th scope="col">Action</th>
                            <th scope="col">Table / Record</th>
                            <th scope="col">Field</th>
                            <th scope="col">Old Value</th>
                            <th scope="col">New Value</th>
                            <th scope="col">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                            {% set user = user_lookup.get(entry.user_id) %}
                            <tr>
                                <td class="text-nowrap">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    {% if user %}
                                        <div>{{ user.full_name or user.username }}</div>
                                        <div class="small text-muted">{{ user.username }}</div>
                                    {% else %}
                                        <span class="text-muted">System</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge {% if entry.action == 'DELETE' %}bg-danger{% elif entry.action == 'UPDATE' %}bg-warning text-dark{% else %}bg-success{% endif %}">{{ entry.action }}</span></td>
                                <td>
                                    <div class="fw-semibold text-capitalize">{{ entry.table_name }}</div>
                                    <div class="small text-muted">ID: {{ entry.record_id if entry.record_id is not none else '—' }}</div>
                                </td>
                                <td>{{ entry.field_name or '—' }}</td>
                                <td>
                                    {% if entry.old_value %}
                                        <pre class="small text-muted mb-0">{{ entry.old_value }}</pre>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if entry.new_value %}
                                        <pre class="small text-muted mb-0">{{ entry.new_value }}</pre>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.notes or '—' }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="p-4 text-center text-muted">
                <i class="bi bi-archive fs-1 d-block mb-2"></i>
                <p class="mb-0">No audit entries match the selected criteria.</p>
            </div>
        {% endif %}
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
        <span class="text-muted small">Page {{ summary.page }} &middot; {{ per_page }} per page</span>
        <div class="d-flex gap-2">
            {% if has_prev %}
                <a href="{{ url_for('admin.audit_log', **prev_args) }}" class="btn btn-outline-secondary btn-sm">Previous</a>
            {% else %}
                <button class="btn btn-outline-secondary btn-sm" disabled>Previous</button>
            {% endif %}
            {% if has_next %}
                <a href="{{ url_for('admin.audit_log', **next_args) }}" class="btn btn-outline-secondary btn-sm">Next</a>
            {% else %}
                <button class="btn btn-outline-secondary btn-sm" disabled>Next</button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
