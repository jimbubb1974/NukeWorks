{% extends "base.html" %}

{% block title %}Client Management - NukeWorks{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="bi bi-people-fill"></i> Client Management</h2>
        </div>
    </div>

    <!-- MPR Clients Table -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    {% if companies_with_details %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        <a href="{{ url_for('crm.dashboard', sort_by='company_name', sort_order='asc' if sort_by != 'company_name' or sort_order == 'desc' else 'desc', priority=request.args.get('priority', ''), status=request.args.get('status', ''), poc=request.args.get('poc', '')) }}" class="text-decoration-none text-dark">
                                            Company Name
                                            {% if sort_by == 'company_name' %}
                                                <i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="{{ url_for('crm.dashboard', sort_by='priority', sort_order='asc' if sort_by != 'priority' or sort_order == 'desc' else 'desc', priority=request.args.get('priority', ''), status=request.args.get('status', ''), poc=request.args.get('poc', '')) }}" class="text-decoration-none text-dark">
                                            Priority
                                            {% if sort_by == 'priority' %}
                                                <i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>Personnel</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company_data in companies_with_details %}
                                {% set company = company_data.company %}
                                {% set profile = company.client_profile %}
                                {% set personnel_with_connections = company_data.personnel_with_connections %}
                                {% set recent_roundtables = company_data.recent_roundtables %}
                                <tr>
                                    <td>
                                        <strong>{{ company.company_name }}</strong>
                                        {% if not profile %}
                                            <br><small class="text-warning"><i class="bi bi-exclamation-triangle"></i> No CRM data yet</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if profile and profile.client_priority %}
                                            <span class="badge bg-{% if profile.client_priority in ['Strategic', 'High'] %}danger{% elif profile.client_priority == 'Medium' %}warning{% else %}secondary{% endif %}">
                                                {{ profile.client_priority }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">Not set</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if personnel_with_connections %}
                                            {% for item in personnel_with_connections[:2] %}
                                                {% set person = item.person %}
                                                <div class="small">
                                                    {{ person.full_name }}
                                                    {% if person.role %}<span class="text-muted"> - {{ person.role }}</span>{% endif %}
                                                </div>
                                            {% endfor %}
                                            {% if personnel_with_connections|length > 2 %}
                                                <small class="text-muted">+{{ personnel_with_connections|length - 2 }} more</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No contacts</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('crm.add_roundtable_entry', company_id=company.company_id) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Add Roundtable Discussion">
                                            <i class="bi bi-clipboard-check"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">No MPR Clients Found</h5>
                        <p class="text-muted">No companies are currently flagged as MPR clients.</p>
                        <a href="{{ url_for('companies.list_companies') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Companies
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('crm.dashboard') }}" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Priority</label>
                            <select name="priority" class="form-select" onchange="this.form.submit()">
                                <option value="">All Priorities</option>
                                <option value="Strategic" {% if priority_filter == 'Strategic' %}selected{% endif %}>Strategic</option>
                                <option value="High" {% if priority_filter == 'High' %}selected{% endif %}>High</option>
                                <option value="Medium" {% if priority_filter == 'Medium' %}selected{% endif %}>Medium</option>
                                <option value="Low" {% if priority_filter == 'Low' %}selected{% endif %}>Low</option>
                                <option value="Opportunistic" {% if priority_filter == 'Opportunistic' %}selected{% endif %}>Opportunistic</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select" onchange="this.form.submit()">
                                <option value="">All Statuses</option>
                                <option value="Active" {% if status_filter == 'Active' %}selected{% endif %}>Active</option>
                                <option value="Warm" {% if status_filter == 'Warm' %}selected{% endif %}>Warm</option>
                                <option value="Cold" {% if status_filter == 'Cold' %}selected{% endif %}>Cold</option>
                                <option value="Inactive" {% if status_filter == 'Inactive' %}selected{% endif %}>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">POC</label>
                            <select name="poc" class="form-select" onchange="this.form.submit()">
                                <option value="">All POCs</option>
                                {% for poc in poc_choices %}
                                <option value="{{ poc.user_id }}" {% if poc_filter == poc.user_id|string %}selected{% endif %}>{{ poc.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sort By</label>
                            <select name="sort_by" class="form-select" onchange="this.form.submit()">
                                <option value="company_name" {% if sort_by == 'company_name' %}selected{% endif %}>Company Name</option>
                                <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
                                <option value="last_contact" {% if sort_by == 'last_contact' %}selected{% endif %}>Last Contact</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modals -->
{% for company_data in companies_with_details %}
{% set company = company_data.company %}
{% set profile = company.client_profile %}
{% set personnel_with_connections = company_data.personnel_with_connections %}
{% set recent_roundtables = company_data.recent_roundtables %}
<div class="modal fade" id="detailsModal{{ company.company_id }}" tabindex="-1" aria-labelledby="detailsModalLabel{{ company.company_id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel{{ company.company_id }}">
                    <i class="bi bi-building"></i> {{ company.company_name }} - Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Company Personnel -->
                {% if personnel_with_connections %}
                <div class="mb-4">
                    <h6><i class="bi bi-people"></i> Personnel Contacts</h6>
                    {% for item in personnel_with_connections %}
                    {% set person = item.person %}
                    {% set mpr_connections = item.mpr_connections %}
                    <div class="d-flex justify-content-between align-items-start mb-3 p-2 border rounded">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                {{ person.full_name }}
                                {% if person.role %}
                                    <span class="badge bg-secondary ms-2">{{ person.role }}</span>
                                {% endif %}
                            </div>
                            <div class="small text-muted mb-1">
                                {% if person.email %}
                                    <i class="bi bi-envelope"></i> <a href="mailto:{{ person.email }}">{{ person.email }}</a>
                                {% endif %}
                                {% if person.phone %}
                                    <i class="bi bi-telephone ms-2"></i> {{ person.phone }}
                                {% endif %}
                            </div>
                            {% if mpr_connections %}
                                <div class="small">
                                    MPR Connections:
                                    {% for connection in mpr_connections %}
                                        {% if connection.personnel %}
                                            {% set last_name = connection.personnel.full_name.split()[-1] if connection.personnel.full_name else 'Unknown' %}
                                            {{ last_name }}{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="small text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> No MPR Connections
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="mb-4">
                    <h6><i class="bi bi-people"></i> Personnel Contacts</h6>
                    <p class="text-muted">No personnel contacts found.</p>
                </div>
                {% endif %}
                
                <!-- Recent Roundtable Entries -->
                {% if recent_roundtables %}
                <div class="mb-4">
                    <h6><i class="bi bi-clipboard-check"></i> Recent Roundtable Entries</h6>
                    {% for entry in recent_roundtables %}
                    <div class="card bg-light mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <strong>{{ entry.created_timestamp.strftime('%B %d, %Y %I:%M %p') }}</strong>
                            </div>
                            {% if entry.next_steps %}
                            <div class="small mb-1">
                                <strong>Next Steps:</strong> {{ entry.next_steps[:150] }}{% if entry.next_steps|length > 150 %}...{% endif %}
                            </div>
                            {% endif %}
                            {% if entry.client_near_term_focus %}
                            <div class="small mb-1">
                                <strong>Client Focus:</strong> {{ entry.client_near_term_focus[:150] }}{% if entry.client_near_term_focus|length > 150 %}...{% endif %}
                            </div>
                            {% endif %}
                            {% if entry.mpr_work_targets %}
                            <div class="small mb-1">
                                <strong>MPR Targets:</strong> {{ entry.mpr_work_targets[:150] }}{% if entry.mpr_work_targets|length > 150 %}...{% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="mb-4">
                    <h6><i class="bi bi-clipboard-check"></i> Recent Roundtable Entries</h6>
                    <p class="text-muted">No roundtable entries found.</p>
                </div>
                {% endif %}
                
                <!-- CRM Profile Data -->
                {% if profile %}
                <div class="mb-4">
                    <h6><i class="bi bi-info-circle"></i> CRM Profile</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">{{ profile.client_status or '—' }}</dd>
                                <dt class="col-sm-4">Relationship:</dt>
                                <dd class="col-sm-8">{{ profile.relationship_strength or '—' }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Last Contact:</dt>
                                <dd class="col-sm-8">
                                    {% if profile.last_contact_date %}
                                        {{ profile.last_contact_date.strftime('%Y-%m-%d') }}
                                        {% if profile.last_contact_type %}({{ profile.last_contact_type }}){% endif %}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </dd>
                                <dt class="col-sm-4">Next Contact:</dt>
                                <dd class="col-sm-8">
                                    {% if profile.next_planned_contact_date %}
                                        {{ profile.next_planned_contact_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        Not planned
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                    {% if profile.relationship_notes %}
                    <div class="mt-2">
                        <strong>Notes:</strong> {{ profile.relationship_notes[:200] }}{% if profile.relationship_notes|length > 200 %}...{% endif %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="mb-4">
                    <h6><i class="bi bi-info-circle"></i> CRM Profile</h6>
                    <p class="text-muted">No CRM profile data available. <a href="{{ url_for('companies.edit_company', company_id=company.company_id) }}">Add CRM data</a></p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('companies.view_company', company_id=company.company_id) }}" class="btn btn-primary">View Full Company</a>
                <a href="{{ url_for('companies.edit_company', company_id=company.company_id) }}" class="btn btn-outline-secondary">Edit Company</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}