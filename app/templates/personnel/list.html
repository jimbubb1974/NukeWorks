{% extends 'base.html' %} {% block title %}Personnel Directory - NukeWorks{%
endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <h1 class="h3 mb-0"><i class="bi bi-people"></i> Personnel Directory</h1>
  </div>
</div>

<form class="row g-2 align-items-center mb-4" method="get">
  <div class="col-sm-4 col-md-3">
    <label for="searchTerm" class="form-label mb-0">Search</label>
    <input
      type="search"
      class="form-control"
      id="searchTerm"
      name="q"
      value="{{ search_term }}"
      placeholder="Name, email, role, type..."
    />
  </div>
  <div class="col-auto align-self-end">
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-search"></i> Search
    </button>
  </div>
  {% if search_term %}
  <div class="col-auto align-self-end">
    <a
      href="{{ url_for('personnel.list_personnel') }}"
      class="btn btn-outline-secondary"
      >Clear</a
    >
  </div>
  {% endif %}
</form>

<div class="row">
  <div class="col-xl-6">
    <div class="card mb-4">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h2 class="h5 mb-0">
          <i class="bi bi-building"></i> Internal Personnel (MPR)
        </h2>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary">{{ internal_personnel|length }}</span>
          <a
            href="{{ url_for('personnel.create_personnel', personnel_type='Internal') }}"
            class="btn btn-sm btn-outline-primary"
            title="Add Internal Personnel"
          >
            <i class="bi bi-person-plus"></i>
          </a>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Role</th>
              <th>Email</th>
              <th>Phone</th>
              <th>External Contacts</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if internal_personnel %} {% for person in internal_personnel %}
            <tr>
              <td>{{ person.full_name }}</td>
              <td>{{ person.role or '-' }}</td>
              <td>
                {% if person.email %}<a href="mailto:{{ person.email }}"
                  >{{ person.email }}</a
                >{% else %}-{% endif %}
              </td>
              <td>{{ person.phone or '-' }}</td>
              <td>
                {% set connections =
                internal_connections.get(person.personnel_id, []) %} {% if
                connections %} {% for connection in connections %}
                <a
                  href="{{ connection.url }}"
                  class="badge bg-light text-dark border me-1 mb-1"
                  >{{ connection.name }}</a
                >
                {% endfor %} {% else %}
                <span class="text-muted">None</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a
                  href="{{ url_for('personnel.edit_personnel', personnel_id=person.personnel_id, type='internal') }}"
                  class="btn btn-sm btn-outline-primary me-1"
                  title="Edit"
                >
                  <i class="bi bi-pencil"></i>
                </a>
                <!-- Removed: Manage client connections button - feature removed in Phase 4 cleanup -->
                {% if can_delete %}
                <form
                  method="post"
                  action="{{ url_for('personnel.delete_personnel', personnel_id=person.personnel_id) }}"
                  class="d-inline"
                >
                  {{ delete_form.hidden_tag() }}
                  <button
                    type="submit"
                    class="btn btn-sm btn-outline-danger"
                    title="Delete"
                    data-confirm="delete"
                    data-confirm-message="Delete {{ person.full_name }}? This cannot be undone."
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
              <td colspan="5" class="text-muted text-center py-4">
                No internal personnel found.
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-xl-6">
    <div class="card mb-4">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h2 class="h5 mb-0">
          <i class="bi bi-people-fill"></i> External Contacts
        </h2>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-secondary"
            >{{ external_personnel|length }}</span
          >
          <a
            href="{{ url_for('personnel.create_personnel', personnel_type='Client_Contact') }}"
            class="btn btn-sm btn-outline-secondary"
            title="Add External Contact"
          >
            <i class="bi bi-person-plus"></i>
          </a>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Role</th>
              <th>Email</th>
              <th>Company</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if external_personnel %} {% for person in external_personnel %}
            <tr>
              <td>{{ person.full_name }}</td>
              <td>{{ person.role or '-' }}</td>
              <td>
                {% if person.email %}<a href="mailto:{{ person.email }}"
                  >{{ person.email }}</a
                >{% else %}-{% endif %}
              </td>
              <td>
                {% if person.company %}
                <a
                  href="{{ url_for('companies.view_company', company_id=person.company_id) }}"
                  class="badge bg-primary"
                  >{{ person.company.company_name }}</a
                >
                {% else %}
                <span class="text-muted">No company</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a
                  href="{{ url_for('personnel.edit_personnel', personnel_id=person.personnel_id, type='external') }}"
                  class="btn btn-sm btn-outline-primary me-1"
                  title="Edit"
                >
                  <i class="bi bi-pencil"></i>
                </a>
                {% if can_delete %}
                <form
                  method="post"
                  action="{{ url_for('personnel.delete_personnel', personnel_id=person.personnel_id) }}"
                  class="d-inline"
                >
                  {{ delete_form.hidden_tag() }}
                  <button
                    type="submit"
                    class="btn btn-sm btn-outline-danger"
                    title="Delete"
                    data-confirm="delete"
                    data-confirm-message="Delete {{ person.full_name }}?"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
              <td colspan="5" class="text-muted text-center py-4">
                No external contacts found.
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
