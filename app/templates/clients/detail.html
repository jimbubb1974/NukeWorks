{% extends "base.html" %}

{% block title %}{{ client.client_name }} - NukeWorks{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('clients.list_clients') }}">Clients</a></li>
                    <li class="breadcrumb-item active">{{ client.client_name }}</li>
                </ol>
            </nav>
            <h2><i class="bi bi-people"></i> {{ client.client_name }}</h2>
            {% if client.client_type %}
                <span class="badge bg-secondary">{{ client.client_type }}</span>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('clients.edit_client', client_id=client.client_id) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            {% if current_user.is_admin %}
            <a href="{{ url_for('clients.delete_client', client_id=client.client_id) }}" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Client Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Client Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Client ID:</dt>
                        <dd class="col-sm-8">{{ client.client_id }}</dd>

                        <dt class="col-sm-4">Client Name:</dt>
                        <dd class="col-sm-8">{{ client.client_name }}</dd>

                        {% if company_record %}
                        <dt class="col-sm-4">Unified Company:</dt>
                        <dd class="col-sm-8">
                            <div>{{ company_record.company_name }}</div>
                            <small class="text-muted">Company ID: {{ company_record.company_id }}</small>
                        </dd>
                        {% endif %}

                        <dt class="col-sm-4">Type:</dt>
                        <dd class="col-sm-8">{{ client.client_type or '—' }}</dd>

                        <dt class="col-sm-4">Notes:</dt>
                        <dd class="col-sm-8">
                            {% if client.notes %}
                                <div style="white-space: pre-wrap;">{{ client.notes }}</div>
                            {% else %}
                                <span class="text-muted">No notes</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">
                            {% if client.created_date %}
                                {{ client.created_date.strftime('%B %d, %Y at %I:%M %p') }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Last Modified:</dt>
                        <dd class="col-sm-8">
                            {% if client.modified_date %}
                                {{ client.modified_date.strftime('%B %d, %Y at %I:%M %p') }}
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- MPR Team -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> MPR Team</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Primary POC:</dt>
                        <dd class="col-sm-8">
                            {% if client.mpr_primary_contact %}
                                {{ client.mpr_primary_contact.full_name }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Secondary POC:</dt>
                        <dd class="col-sm-8">
                            {% if client.mpr_secondary_contact %}
                                {{ client.mpr_secondary_contact.full_name }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Contact Tracking & Assessment -->
        <div class="col-md-6">
            <!-- Contact Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-telephone"></i> Contact Tracking</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Last Contact:</dt>
                        <dd class="col-sm-7">
                            {% if client.last_contact_date %}
                                {{ client.last_contact_date.strftime('%B %d, %Y') }}
                                {% if client.last_contact_type %}
                                    <span class="badge bg-secondary">{{ client.last_contact_type }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </dd>

                        {% if client.last_contact_by_person %}
                        <dt class="col-sm-5">Contacted By:</dt>
                        <dd class="col-sm-7">{{ client.last_contact_by_person.full_name }}</dd>
                        {% endif %}

                        {% if client.last_contact_notes %}
                        <dt class="col-sm-5">Notes:</dt>
                        <dd class="col-sm-7">
                            <div style="white-space: pre-wrap;">{{ client.last_contact_notes }}</div>
                        </dd>
                        {% endif %}

                        <dt class="col-sm-5">Next Planned:</dt>
                        <dd class="col-sm-7">
                            {% if client.next_planned_contact_date %}
                                {{ client.next_planned_contact_date.strftime('%B %d, %Y') }}
                                {% if client.next_planned_contact_type %}
                                    <span class="badge bg-info">{{ client.next_planned_contact_type }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not scheduled</span>
                            {% endif %}
                        </dd>

                        {% if client.next_contact_assigned_person %}
                        <dt class="col-sm-5">Assigned To:</dt>
                        <dd class="col-sm-7">{{ client.next_contact_assigned_person.full_name }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Internal Assessment (NED Team Only) -->
            {% if can_see_ned_fields %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Internal Assessment <span class="badge bg-dark">NED Team Only</span></h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Priority:</dt>
                        <dd class="col-sm-7">{{ client.client_priority or '—' }}</dd>

                        <dt class="col-sm-5">Status:</dt>
                        <dd class="col-sm-7">{{ client.client_status or '—' }}</dd>

                        <dt class="col-sm-5">Relationship:</dt>
                        <dd class="col-sm-7">{{ client.relationship_strength or '—' }}</dd>

                        <dt class="col-sm-5">Strategy Notes:</dt>
                        <dd class="col-sm-7">
                            {% if client.relationship_notes %}
                                <div style="white-space: pre-wrap;">{{ client.relationship_notes }}</div>
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Relationships -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-building"></i> Linked Owners/Developers ({{ owner_relationships|length }})</h5>
                    <a href="{{ url_for('clients.add_owner_relationship', client_id=client.client_id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Add
                    </a>
                </div>
                <div class="card-body">
                    {% if owner_relationships %}
                    <ul class="list-group list-group-flush">
                        {% for rel in owner_relationships %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ rel.owner.company_name if rel.owner else 'Unknown' }}</strong>
                                {% if rel.notes %}<br><small class="text-muted">{{ rel.notes }}</small>{% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('clients.remove_owner_relationship', client_id=client.client_id, owner_id=rel.owner_id) }}" style="display:inline;">
                                {{ remove_form.hidden_tag() }}
                                <button type="submit" class="btn btn-sm btn-outline-danger" data-confirm="delete" data-confirm-message="Remove this owner relationship?">
                                    <i class="bi bi-x"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No linked owners/developers.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-building-check"></i> Linked Projects ({{ project_relationships|length }})</h5>
                    <a href="{{ url_for('clients.add_project_relationship', client_id=client.client_id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Add
                    </a>
                </div>
                <div class="card-body">
                    {% if project_relationships %}
                    <ul class="list-group list-group-flush">
                        {% for rel in project_relationships %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ rel.project.project_name if rel.project else 'Unknown' }}</strong>
                                {% if rel.relationship_type %}<br><small class="badge bg-info">{{ rel.relationship_type }}</small>{% endif %}
                                {% if rel.notes %}<br><small class="text-muted">{{ rel.notes }}</small>{% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('clients.remove_project_relationship', client_id=client.client_id, project_id=rel.project_id) }}" style="display:inline;">
                                {{ remove_form.hidden_tag() }}
                                <button type="submit" class="btn btn-sm btn-outline-danger" data-confirm="delete" data-confirm-message="Remove this project relationship?">
                                    <i class="bi bi-x"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No linked projects.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-building-gear"></i> Linked Operators ({{ operator_relationships|length }})</h5>
                    <a href="{{ url_for('clients.add_operator_relationship', client_id=client.client_id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Add
                    </a>
                </div>
                <div class="card-body">
                    {% if operator_relationships %}
                    <ul class="list-group list-group-flush">
                        {% for rel in operator_relationships %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ rel.operator.company_name if rel.operator else 'Unknown' }}</strong>
                                {% if rel.notes %}<br><small class="text-muted">{{ rel.notes }}</small>{% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('clients.remove_operator_relationship', client_id=client.client_id, operator_id=rel.operator_id) }}" style="display:inline;">
                                {{ remove_form.hidden_tag() }}
                                <button type="submit" class="btn btn-sm btn-outline-danger" data-confirm="delete" data-confirm-message="Remove this operator relationship?">
                                    <i class="bi bi-x"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No linked operators.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Linked Technologies ({{ vendor_relationships|length }})</h5>
                    <a href="{{ url_for('clients.add_vendor_relationship', client_id=client.client_id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Add
                    </a>
                </div>
                <div class="card-body">
                    {% if vendor_relationships %}
                    <ul class="list-group list-group-flush">
                        {% for rel in vendor_relationships %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ rel.vendor.vendor_name if rel.vendor else 'Unknown' }}</strong>
                                {% if rel.notes %}<br><small class="text-muted">{{ rel.notes }}</small>{% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('clients.remove_vendor_relationship', client_id=client.client_id, vendor_id=rel.vendor_id) }}" style="display:inline;">
                                {{ remove_form.hidden_tag() }}
                                <button type="submit" class="btn btn-sm btn-outline-danger" data-confirm="delete" data-confirm-message="Remove this vendor relationship?">
                                    <i class="bi bi-x"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No linked technologies.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Key Personnel ({{ personnel_relationships|length }})</h5>
                    <a href="{{ url_for('clients.add_personnel_relationship', client_id=client.client_id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Add
                    </a>
                </div>
                <div class="card-body">
                    {% if personnel_relationships %}
                    <ul class="list-group list-group-flush">
                        {% for rel in personnel_relationships %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ rel.person.full_name if rel.person else 'Unknown' }}</strong>
                                {% if rel.role_at_client %}<br><small class="text-muted">{{ rel.role_at_client }}</small>{% endif %}
                                {% if rel.is_primary_contact %}<span class="badge bg-primary ms-2">Primary Contact</span>{% endif %}
                                {% if rel.mpr_relationship_strength %}<br><small class="text-muted">MPR Relationship: {{ rel.mpr_relationship_strength }}</small>{% endif %}
                            </div>
                            <form method="POST" action="{{ url_for('clients.remove_personnel_relationship', client_id=client.client_id, personnel_id=rel.personnel_id) }}" style="display:inline;">
                                {{ remove_form.hidden_tag() }}
                                <button type="submit" class="btn btn-sm btn-outline-danger" data-confirm="delete" data-confirm-message="Remove this personnel relationship?">
                                    <i class="bi bi-x"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No key personnel linked.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Roundtable History (NED Team Only) -->
    {% if can_see_ned_fields %}
    <div class="row">
        <div class="col-12">
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Roundtable History (Last 3) <span class="badge bg-dark">NED Team Only</span></h5>
                </div>
                <div class="card-body">
                    {% if roundtable_history %}
                    {% for entry in roundtable_history %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>{{ entry.meeting_date.strftime('%B %d, %Y') }}</strong>
                        </div>
                        <div class="card-body">
                            {% if entry.next_steps %}
                            <h6>Next Steps:</h6>
                            <div style="white-space: pre-wrap;" class="mb-2">{{ entry.next_steps }}</div>
                            {% endif %}

                            {% if entry.client_near_term_focus %}
                            <h6>Client Near-Term Focus:</h6>
                            <div style="white-space: pre-wrap;" class="mb-2">{{ entry.client_near_term_focus }}</div>
                            {% endif %}

                            {% if entry.mpr_work_targets %}
                            <h6>MPR Work Targets:</h6>
                            <div style="white-space: pre-wrap;" class="mb-2">{{ entry.mpr_work_targets }}</div>
                            {% endif %}

                            {% if entry.discussion %}
                            <h6>Discussion:</h6>
                            <div style="white-space: pre-wrap;" class="mb-2">{{ entry.discussion }}</div>
                            {% endif %}

                            {% if entry.action_items %}
                            <h6>Action Items:</h6>
                            <div style="white-space: pre-wrap;">{{ entry.action_items }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0">No roundtable history yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Contacts -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Contacts (Last 10)</h5>
                </div>
                <div class="card-body">
                    {% if recent_contacts %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Contact</th>
                                    <th>Summary</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contact in recent_contacts %}
                                <tr>
                                    <td>{{ contact.contact_date.strftime('%Y-%m-%d') }}</td>
                                    <td><span class="badge bg-secondary">{{ contact.contact_type or '—' }}</span></td>
                                    <td>{{ contact.contacted_by or '—' }}</td>
                                    <td>{{ contact.contact_summary[:100] if contact.contact_summary else '—' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No contact history yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
