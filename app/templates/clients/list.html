{% extends "base.html" %}

{% block title %}CRM Clients - NukeWorks{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Actions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="bi bi-people"></i> CRM Clients</h2>
            <p class="text-muted">Client relationship management and tracking</p>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('clients.create_client') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add New Client
            </a>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-3">
        <div class="col-md-6">
            <form method="GET" action="{{ url_for('clients.list_clients') }}" class="input-group">
                <input type="text" name="search" class="form-control" placeholder="Search clients..." value="{{ search or '' }}">
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="bi bi-search"></i> Search
                </button>
                {% if search %}
                <a href="{{ url_for('clients.list_clients') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Clear
                </a>
                {% endif %}
            </form>
        </div>
        {% if can_see_ned_fields %}
        <div class="col-md-6">
            <form method="GET" action="{{ url_for('clients.list_clients') }}" class="row g-2">
                <div class="col-auto">
                    <select name="priority" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">All Priorities</option>
                        <option value="High" {% if priority_filter == 'High' %}selected{% endif %}>High</option>
                        <option value="Medium" {% if priority_filter == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="Low" {% if priority_filter == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Strategic" {% if priority_filter == 'Strategic' %}selected{% endif %}>Strategic</option>
                        <option value="Opportunistic" {% if priority_filter == 'Opportunistic' %}selected{% endif %}>Opportunistic</option>
                    </select>
                </div>
                <div class="col-auto">
                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="Active" {% if status_filter == 'Active' %}selected{% endif %}>Active</option>
                        <option value="Warm" {% if status_filter == 'Warm' %}selected{% endif %}>Warm</option>
                        <option value="Cold" {% if status_filter == 'Cold' %}selected{% endif %}>Cold</option>
                        <option value="Prospective" {% if status_filter == 'Prospective' %}selected{% endif %}>Prospective</option>
                    </select>
                </div>
                {% if priority_filter or status_filter %}
                <div class="col-auto">
                    <a href="{{ url_for('clients.list_clients') }}" class="btn btn-sm btn-outline-secondary">
                        Clear Filters
                    </a>
                </div>
                {% endif %}
            </form>
        </div>
        {% endif %}
    </div>

    <div class="row mb-2">
        <div class="col-12 text-end">
            <span class="text-muted">{{ clients|length }} client(s){% if search or priority_filter or status_filter %} found{% endif %}</span>
        </div>
    </div>

    <!-- Clients Table -->
    <div class="row">
        <div class="col-12">
            {% if clients %}
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Client Name</th>
                                    <th>Type</th>
                                    <th>MPR Primary POC</th>
                                    <th>Last Contact</th>
                                    {% if can_see_ned_fields %}
                                    <th>Priority</th>
                                    <th>Status</th>
                                    {% endif %}
                                    <th>Relationships</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('clients.view_client', client_id=client.client_id) }}" class="fw-bold text-decoration-none">
                                            {{ client.client_name }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if client.client_type %}
                                            <span class="badge bg-secondary">{{ client.client_type }}</span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if client.mpr_primary_contact %}
                                            {{ client.mpr_primary_contact.full_name }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if client.last_contact_date %}
                                            {% set days_ago = (today - client.last_contact_date).days %}
                                            {% if days_ago > 90 %}
                                                <span class="text-danger">{{ client.last_contact_date.strftime('%Y-%m-%d') }} ({{ days_ago }}d ago)</span>
                                            {% elif days_ago > 60 %}
                                                <span class="text-warning">{{ client.last_contact_date.strftime('%Y-%m-%d') }} ({{ days_ago }}d ago)</span>
                                            {% else %}
                                                {{ client.last_contact_date.strftime('%Y-%m-%d') }} ({{ days_ago }}d ago)
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    {% if can_see_ned_fields %}
                                    <td>
                                        {% if client.client_priority %}
                                            {% if client.client_priority == 'High' or client.client_priority == 'Strategic' %}
                                                <span class="badge bg-danger">{{ client.client_priority }}</span>
                                            {% elif client.client_priority == 'Medium' %}
                                                <span class="badge bg-warning">{{ client.client_priority }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ client.client_priority }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if client.client_status %}
                                            {% if client.client_status == 'Active' %}
                                                <span class="badge bg-success">{{ client.client_status }}</span>
                                            {% elif client.client_status == 'Warm' %}
                                                <span class="badge bg-info">{{ client.client_status }}</span>
                                            {% elif client.client_status == 'Cold' %}
                                                <span class="badge bg-secondary">{{ client.client_status }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ client.client_status }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td>
                                        {% set counts = client_counts.get(client.client_id, {}) %}
                                        <small>
                                            {% if counts.projects > 0 %}<span class="badge bg-primary">{{ counts.projects }} Project(s)</span> {% endif %}
                                            {% if counts.owners > 0 %}<span class="badge bg-info">{{ counts.owners }} Owner(s)</span> {% endif %}
                                            {% if counts.vendors > 0 %}<span class="badge bg-success">{{ counts.vendors }} Tech(s)</span> {% endif %}
                                            {% if counts.owners == 0 and counts.projects == 0 and counts.vendors == 0 %}
                                                <span class="text-muted">None</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <a href="{{ url_for('clients.view_client', client_id=client.client_id) }}" class="btn btn-sm btn-outline-primary" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('clients.edit_client', client_id=client.client_id) }}" class="btn btn-sm btn-outline-secondary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                {% if search or priority_filter or status_filter %}
                    No clients found matching your search criteria. <a href="{{ url_for('clients.list_clients') }}">Show all clients</a>
                {% else %}
                    No clients have been added yet. <a href="{{ url_for('clients.create_client') }}">Add your first client</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
