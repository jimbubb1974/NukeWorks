{% extends "base.html" %}

{% block title %}{{ vendor.vendor_name }} - NukeWorks{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('vendors.list_vendors') }}">Vendors</a></li>
                    <li class="breadcrumb-item active">{{ vendor.vendor_name }}</li>
                </ol>
            </nav>
            <h2><i class="bi bi-building"></i> {{ vendor.vendor_name }}</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('vendors.edit_vendor', vendor_id=vendor.vendor_id) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            {% if current_user.is_admin %}
            <a href="{{ url_for('vendors.delete_vendor', vendor_id=vendor.vendor_id) }}" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Vendor Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Vendor Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Vendor ID:</dt>
                        <dd class="col-sm-8">{{ vendor.vendor_id }}</dd>

                        <dt class="col-sm-4">Vendor Name:</dt>
                        <dd class="col-sm-8">{{ vendor.vendor_name }}</dd>

                        {% if company_record %}
                        <dt class="col-sm-4">Company (Unified):</dt>
                        <dd class="col-sm-8">
                            <div>{{ company_record.company_name }}</div>
                            <small class="text-muted">Company ID: {{ company_record.company_id }}</small>
                        </dd>
                        {% endif %}

                        <dt class="col-sm-4">Notes:</dt>
                        <dd class="col-sm-8">
                            {% if vendor.notes %}
                                <div style="white-space: pre-wrap;">{{ vendor.notes }}</div>
                            {% else %}
                                <span class="text-muted">No notes</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">
                            {% if vendor.created_date %}
                                {{ vendor.created_date.strftime('%B %d, %Y at %I:%M %p') }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Last Modified:</dt>
                        <dd class="col-sm-8">
                            {% if vendor.modified_date %}
                                {{ vendor.modified_date.strftime('%B %d, %Y at %I:%M %p') }}
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Products -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Technologies ({{ products|length }})</h5>
                    {% if can_manage_relationships %}
                    <a href="{{ url_for('technologies.create_technology', vendor_id=vendor.vendor_id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> Add Technology
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if products %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Model</th>
                                    <th>Reactor Type</th>
                                    <th>Generation</th>
                                    <th>Gross Capacity (MWt)</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr>
                                    <td>{{ product.product_name }}</td>
                                    <td>{{ product.reactor_type or '—' }}</td>
                                    <td>{{ product.generation or '—' }}</td>
                                    <td>{{ product.gross_capacity_mwt or '—' }}</td>
                                    <td>{{ product.design_status or '—' }}</td>
                                    <td class="text-end">
                                        <a href="{{ url_for('technologies.view_technology', product_id=product.product_id) }}" class="btn btn-sm btn-outline-secondary">View</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No technologies recorded for this vendor.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Suppliers -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Suppliers ({{ supplier_relationships|length }})</h5>
                </div>
                <div class="card-body">
                    {% if supplier_relationships %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Supplier</th>
                                        <th>Component Type</th>
                                        <th>Confidential</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rel in supplier_relationships %}
                                    <tr>
                                        <td>{{ rel.supplier.vendor_name if rel.supplier else 'Unknown' }}</td>
                                        <td>{{ rel.component_type or '—' }}</td>
                                        <td>
                                            {% if rel.is_confidential %}
                                                <span class="badge bg-warning">Confidential</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Public</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if can_manage_relationships %}
                                            <form method="post" action="{{ url_for('vendors.delete_vendor_supplier_relationship', vendor_id=vendor.vendor_id, relationship_id=rel.relationship_id) }}">
                                                {{ delete_form.csrf_token }}
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove" data-confirm="delete" data-confirm-message="Remove this supplier relationship?">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No suppliers linked to this vendor.</p>
                    {% endif %}

                    {% if can_manage_relationships and supplier_form %}
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#vendorSupplierForm" aria-expanded="false" aria-controls="vendorSupplierForm">
                            <i class="bi bi-plus-circle"></i> Add Supplier Relationship
                        </button>
                    </div>
                    <div class="collapse mt-3" id="vendorSupplierForm">
                        <form method="post" action="{{ url_for('vendors.add_vendor_supplier_relationship', vendor_id=vendor.vendor_id) }}">
                            {{ supplier_form.hidden_tag() }}
                            <div class="row g-2">
                                <div class="col-md-6">
                                    {{ supplier_form.supplier_id.label(class="form-label") }}
                                    {{ supplier_form.supplier_id(class="form-select") }}
                                </div>
                                <div class="col-md-6">
                                    {{ supplier_form.component_type.label(class="form-label") }}
                                    {{ supplier_form.component_type(class="form-control", placeholder="e.g., Major Components") }}
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-8">
                                    {{ supplier_form.notes.label(class="form-label") }}
                                    {{ supplier_form.notes(class="form-control", rows="2") }}
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="form-check">
                                        {{ supplier_form.is_confidential(class="form-check-input") }}
                                        {{ supplier_form.is_confidential.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-primary">Add Supplier</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Owners -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Owner / Developer Relationships ({{ owner_relationships|length }})</h5>
                </div>
                <div class="card-body">
                    {% if owner_relationships %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Owner</th>
                                        <th>Type</th>
                                        <th>Confidential</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rel in owner_relationships %}
                                    <tr>
                                        <td>{{ rel.owner.company_name if rel.owner else 'Unknown' }}</td>
                                        <td>{{ rel.relationship_type or '—' }}</td>
                                        <td>
                                            {% if rel.is_confidential %}
                                                <span class="badge bg-warning">Confidential</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Public</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if can_manage_relationships %}
                                            <form method="post" action="{{ url_for('vendors.delete_vendor_owner_relationship', vendor_id=vendor.vendor_id, relationship_id=rel.relationship_id) }}">
                                                {{ delete_form.csrf_token }}
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove" data-confirm="delete" data-confirm-message="Remove this owner relationship?">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No owner relationships have been recorded for this vendor.</p>
                    {% endif %}

                    {% if can_manage_relationships and owner_form %}
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#vendorOwnerForm" aria-expanded="false" aria-controls="vendorOwnerForm">
                            <i class="bi bi-plus-circle"></i> Add Owner Relationship
                        </button>
                    </div>
                    <div class="collapse mt-3" id="vendorOwnerForm">
                        <form method="post" action="{{ url_for('vendors.add_vendor_owner_relationship', vendor_id=vendor.vendor_id) }}">
                            {{ owner_form.hidden_tag() }}
                            <div class="row g-2">
                                <div class="col-md-6">
                                    {{ owner_form.owner_id.label(class="form-label") }}
                                    {{ owner_form.owner_id(class="form-select") }}
                                </div>
                                <div class="col-md-6">
                                    {{ owner_form.relationship_type.label(class="form-label") }}
                                    {{ owner_form.relationship_type(class="form-control", placeholder="e.g., Development Agreement") }}
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-8">
                                    {{ owner_form.notes.label(class="form-label") }}
                                    {{ owner_form.notes(class="form-control", rows="2") }}
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="form-check">
                                        {{ owner_form.is_confidential(class="form-check-input") }}
                                        {{ owner_form.is_confidential.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-primary">Add Owner Relationship</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Project Relationships -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-building-check"></i> Project Relationships ({{ project_relationships|length }})</h5>
                </div>
                <div class="card-body">
                    {% if project_relationships %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Notes</th>
                                        <th>Confidential</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rel in project_relationships %}
                                    <tr>
                                        <td>{{ rel.project.project_name if rel.project else 'Unknown' }}</td>
                                        <td>{{ rel.notes or '—' }}</td>
                                        <td>
                                            {% if rel.is_confidential %}
                                                <span class="badge bg-warning">Confidential</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Public</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if can_manage_relationships %}
                                            <form method="post" action="{{ url_for('vendors.delete_vendor_project_relationship', vendor_id=vendor.vendor_id, relationship_id=rel.relationship_id) }}">
                                                {{ delete_form.csrf_token }}
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove" data-confirm="delete" data-confirm-message="Remove this project relationship?">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No projects currently linked to this vendor.</p>
                    {% endif %}

                    {% if can_manage_relationships and project_form %}
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#vendorProjectForm" aria-expanded="false" aria-controls="vendorProjectForm">
                            <i class="bi bi-plus-circle"></i> Add Project Relationship
                        </button>
                    </div>
                    <div class="collapse mt-3" id="vendorProjectForm">
                        <form method="post" action="{{ url_for('vendors.add_vendor_project_relationship', vendor_id=vendor.vendor_id) }}">
                            {{ project_form.hidden_tag() }}
                            <div class="row g-2">
                                <div class="col-md-6">
                                    {{ project_form.project_id.label(class="form-label") }}
                                    {{ project_form.project_id(class="form-select") }}
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <div class="form-check">
                                        {{ project_form.is_confidential(class="form-check-input") }}
                                        {{ project_form.is_confidential.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                {{ project_form.notes.label(class="form-label") }}
                                {{ project_form.notes(class="form-control", rows="2") }}
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-primary">Add Project</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Preferred Constructors -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-award"></i> Preferred Constructors ({{ preferred_constructor_relationships|length }})</h5>
                </div>
                <div class="card-body">
                    {% if preferred_constructor_relationships %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Constructor</th>
                                        <th>Reason</th>
                                        <th>Confidential</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rel in preferred_constructor_relationships %}
                                    <tr>
                                        <td>{{ rel.constructor.company_name if rel.constructor else 'Unknown' }}</td>
                                        <td>{{ rel.preference_reason or '—' }}</td>
                                        <td>
                                            {% if rel.is_confidential %}
                                                <span class="badge bg-warning">Confidential</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Public</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if can_manage_relationships %}
                                            <form method="post" action="{{ url_for('vendors.delete_vendor_preferred_constructor', vendor_id=vendor.vendor_id, relationship_id=rel.relationship_id) }}">
                                                {{ delete_form.csrf_token }}
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove" data-confirm="delete" data-confirm-message="Remove this preferred constructor?">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No preferred constructors recorded.</p>
                    {% endif %}

                    {% if can_manage_relationships and preferred_constructor_form %}
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#vendorConstructorForm" aria-expanded="false" aria-controls="vendorConstructorForm">
                            <i class="bi bi-plus-circle"></i> Add Preferred Constructor
                        </button>
                    </div>
                    <div class="collapse mt-3" id="vendorConstructorForm">
                        <form method="post" action="{{ url_for('vendors.add_vendor_preferred_constructor', vendor_id=vendor.vendor_id) }}">
                            {{ preferred_constructor_form.hidden_tag() }}
                            <div class="row g-2">
                                <div class="col-md-6">
                                    {{ preferred_constructor_form.constructor_id.label(class="form-label") }}
                                    {{ preferred_constructor_form.constructor_id(class="form-select") }}
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <div class="form-check">
                                        {{ preferred_constructor_form.is_confidential(class="form-check-input") }}
                                        {{ preferred_constructor_form.is_confidential.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                {{ preferred_constructor_form.preference_reason.label(class="form-label") }}
                                {{ preferred_constructor_form.preference_reason(class="form-control", rows="2") }}
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-primary">Add Preferred Constructor</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Personnel Relationships -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Personnel Relationships ({{ personnel_relationships|length }})</h5>
                </div>
                <div class="card-body">
                    {% if personnel_relationships %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Personnel</th>
                                        <th>Role</th>
                                        <th>Confidential</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rel in personnel_relationships %}
                                    <tr>
                                        <td>{{ rel.person.full_name if rel.person else 'Unknown' }}</td>
                                        <td>{{ rel.role_at_entity or '—' }}</td>
                                        <td>
                                            {% if rel.is_confidential %}
                                                <span class="badge bg-warning">Confidential</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Public</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if can_manage_relationships %}
                                            <form method="post" action="{{ url_for('vendors.delete_vendor_personnel_relationship', vendor_id=vendor.vendor_id, relationship_id=rel.relationship_id) }}">
                                                {{ delete_form.csrf_token }}
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove" data-confirm="delete" data-confirm-message="Remove this personnel relationship?">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No personnel relationships recorded.</p>
                    {% endif %}

                    {% if can_manage_relationships and personnel_form %}
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#vendorPersonnelForm" aria-expanded="false" aria-controls="vendorPersonnelForm">
                            <i class="bi bi-plus-circle"></i> Add Personnel Relationship
                        </button>
                    </div>
                    <div class="collapse mt-3" id="vendorPersonnelForm">
                        <form method="post" action="{{ url_for('vendors.add_vendor_personnel_relationship', vendor_id=vendor.vendor_id) }}">
                            {{ personnel_form.hidden_tag() }}
                            <div class="row g-2">
                                <div class="col-md-6">
                                    {{ personnel_form.personnel_id.label(class="form-label") }}
                                    {{ personnel_form.personnel_id(class="form-select") }}
                                </div>
                                <div class="col-md-6">
                                    {{ personnel_form.role_at_entity.label(class="form-label") }}
                                    {{ personnel_form.role_at_entity(class="form-control", placeholder="e.g., CEO") }}
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-8">
                                    {{ personnel_form.notes.label(class="form-label") }}
                                    {{ personnel_form.notes(class="form-control", rows="2") }}
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="form-check">
                                        {{ personnel_form.is_confidential(class="form-check-input") }}
                                        {{ personnel_form.is_confidential.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="submit" class="btn btn-primary">Add Personnel</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Customers (where this vendor is the supplier) -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Customers Using This Vendor as Supplier ({{ customer_relationships|length }})</h5>
                </div>
                <div class="card-body">
                    {% if customer_relationships %}
                        <ul class="list-group list-group-flush">
                            {% for rel in customer_relationships %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ rel.vendor.vendor_name if rel.vendor else 'Unknown Vendor' }}</strong>
                                    {% if rel.component_type %}
                                        <div class="small text-muted">{{ rel.component_type }}</div>
                                    {% endif %}
                                </div>
                                {% if rel.is_confidential %}
                                    <span class="badge bg-warning">Confidential</span>
                                {% else %}
                                    <span class="badge bg-secondary">Public</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">This vendor is not listed as a supplier for other vendors.</p>
                    {% endif %}
                    <div class="mt-3 small text-muted">To manage these relationships, visit the corresponding vendor.</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
