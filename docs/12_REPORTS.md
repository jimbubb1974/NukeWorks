# 12_REPORTS.md - PDF Report Specifications

**Document Version:** 1.0  
**Last Updated:** December 4, 2025

**Related Documents:**
- `02_DATABASE_SCHEMA.md` - Data structures
- `05_PERMISSION_SYSTEM.md` - Confidentiality filtering
- `08_UI_VIEWS_CORE.md` - Report generation UI

---

## Overview

NukeWorks generates three PDF reports with automatic confidentiality filtering:
1. **Project Summary Report** - Comprehensive project overview
2. **Technology Vendor Profile** - Vendor deep-dive
3. **Relationship Map Report** - Network visualization

**Key Features:**
- Automatic confidentiality filtering based on user permissions
- "CONFIDENTIAL" watermark when report contains restricted data
- Company logo and professional formatting
- Export to PDF and Excel

---

## Table of Contents

1. [Report Generation UI](#report-generation-ui)
2. [Project Summary Report](#project-summary-report)
3. [Technology Vendor Profile](#technology-vendor-profile)
4. [Relationship Map Report](#relationship-map-report)
5. [PDF Generation Technical](#pdf-generation-technical)
6. [Excel Export](#excel-export)

---

## Report Generation UI

### Reports Menu

```
═══════════════════════════════════════════════════════════
REPORTS
═══════════════════════════════════════════════════════════

AVAILABLE REPORTS
┌─────────────────────────────────────────────────────────┐
│ Project Summary Report                                   │
│ Comprehensive overview of a single project               │
│ [Generate PDF] [Generate Excel]                          │
├─────────────────────────────────────────────────────────┤
│ Technology Vendor Profile                                │
│ Deep dive into vendor, products, and relationships       │
│ [Generate PDF] [Generate Excel]                          │
├─────────────────────────────────────────────────────────┤
│ Relationship Map Report                                  │
│ Visual and textual network relationship analysis         │
│ [Generate PDF] [Generate Excel]                          │
└─────────────────────────────────────────────────────────┘
```

### Parameter Selection Dialog

```
┌─────────────────────────────────────────────────────────┐
│  Generate Project Summary Report                         │
├─────────────────────────────────────────────────────────┤
│  Select Project: [Search or dropdown            ▼]       │
│                                                          │
│  ☑ Include confidential data                             │
│     (You have access to confidential information)        │
│                                                          │
│  Date Range (optional):                                  │
│    From: [Date picker]                                   │
│    To:   [Date picker]                                   │
│                                                          │
│  Format: ⦿ PDF  ○ Excel                                  │
│                                                          │
│  [Cancel]  [Preview]  [Generate]                         │
└─────────────────────────────────────────────────────────┘
```

---

## Project Summary Report

### Purpose
Comprehensive single-project report with all stakeholders and data

### Report Structure

```
═══════════════════════════════════════════════════════════
[COMPANY LOGO]              PROJECT SUMMARY REPORT
                                [Project Name]
                            
                            Generated: Dec 4, 2025
                            Generated By: John Smith

[CONFIDENTIAL watermark across all pages if applicable]
═══════════════════════════════════════════════════════════

PROJECT DETAILS
───────────────────────────────────────────────────────────
Project Name:           Project Alpha
Location:               Tennessee, USA
Project Status:         Active
Licensing Approach:     Part 52
Configuration:          2-unit SMR deployment
Commercial Operation:   June 2028
MPR Project ID:         MPR-2024-015

FINANCIAL DATA              [Section omitted if no access]
───────────────────────────────────────────────────────────
CAPEX:                  $50,000,000
OPEX:                   $2,000,000/year
Fuel Cost:              $500,000/year
LCOE:                   $85/MWh

SCHEDULE & TIMELINE
───────────────────────────────────────────────────────────
Project Schedule:       On track for Q2 2028 COD
Key Milestones:
  • Licensing submitted: Jan 2024
  • Construction start: Q3 2025
  • First criticality: Q1 2028

STAKEHOLDERS
───────────────────────────────────────────────────────────
Owner/Developer:        ClientCo Energy
  Company Type:         IOU (Investor-Owned Utility)
  Engagement Level:     Invested
  
Technology Vendor:      TechVendor X
  Technology:           Xe-100 SMR
  Reactor Type:         Pressurized Water Reactor
  Thermal Capacity:     200 MWth
  Design Status:        Licensed
  
Constructor:            BuildCorp Construction
  [Details...]
  
Operator:               ClientCo Energy
  [Same as owner]

RELATIONSHIPS                     [Non-confidential only]
───────────────────────────────────────────────────────────
• Owner: ClientCo Energy (Project Developer)
• Technology: TechVendor X (Technology Provider - Xe-100)
• Constructor: BuildCorp Construction (Primary Contractor)
• Operator: ClientCo Energy (Licensed Operator)

[Note: 2 confidential relationships omitted]

PERSONNEL
───────────────────────────────────────────────────────────
Name                Role              Organization
────────────────────────────────────────────────────────────
Jane Smith          Project Director  ClientCo Energy
Bob Johnson         Chief Engineer    TechVendor X
Mike Davis          Construction Mgr  BuildCorp Construction

NOTES
───────────────────────────────────────────────────────────
This project represents ClientCo Energy's first deployment 
of advanced SMR technology. The site has excellent access 
to cooling water and transmission infrastructure...

[Full notes content]

═══════════════════════════════════════════════════════════
                        Page 1 of 2

This report respects data confidentiality settings.
Some information may be omitted based on user permissions.
═══════════════════════════════════════════════════════════
```

### Backend Implementation

```python
@app.route('/reports/project-summary', methods=['GET', 'POST'])
@login_required
def generate_project_summary():
    """Generate Project Summary Report"""
    if request.method == 'POST':
        project_id = request.form.get('project_id')
        include_confidential = request.form.get('include_confidential') == 'on'
        format_type = request.form.get('format', 'pdf')
        
        # Get project
        project = db.query(Projects).get_or_404(project_id)
        
        # Collect report data with permission filtering
        report_data = {
            'project': project,
            'generated_by': current_user.full_name,
            'generated_date': datetime.now(),
            'include_confidential': include_confidential and (current_user.has_confidential_access or current_user.is_admin),
        }
        
        # Financial data (check permissions)
        report_data['financial'] = {}
        for field in ['capex', 'opex', 'fuel_cost', 'lcoe']:
            if can_view_field(current_user, 'Projects', project_id, field):
                report_data['financial'][field] = getattr(project, field)
            else:
                report_data['financial'][field] = '[Confidential]'
        
        # Stakeholders (get visible relationships)
        report_data['vendors'] = get_visible_project_vendors(current_user, project_id)
        report_data['constructors'] = get_visible_project_constructors(current_user, project_id)
        report_data['operators'] = get_visible_project_operators(current_user, project_id)
        report_data['owners'] = get_visible_project_owners(current_user, project_id)
        
        # Count hidden relationships
        report_data['hidden_relationships_count'] = count_hidden_project_relationships(current_user, project_id)
        
        # Personnel
        report_data['personnel'] = get_visible_project_personnel(current_user, project_id)
        
        # Generate PDF or Excel
        if format_type == 'pdf':
            return generate_project_summary_pdf(report_data)
        else:
            return generate_project_summary_excel(report_data)
    
    # GET - show parameter selection form
    projects = db.query(Projects).order_by(Projects.project_name).all()
    return render_template('reports/project_summary_form.html', projects=projects)


def generate_project_summary_pdf(data):
    """Generate PDF using ReportLab or WeasyPrint"""
    from reportlab.lib.pagesizes import letter
    from reportlab.lib.styles import getSampleStyleSheet
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, PageBreak
    from reportlab.lib.units import inch
    from io import BytesIO
    
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=letter)
    story = []
    styles = getSampleStyleSheet()
    
    # Add company logo if configured
    logo_path = get_system_setting('company_logo_path')
    if logo_path:
        from reportlab.platypus import Image
        story.append(Image(logo_path, width=2*inch, height=0.5*inch))
        story.append(Spacer(1, 0.2*inch))
    
    # Title
    title = Paragraph(f"<b>PROJECT SUMMARY REPORT</b><br/>{data['project'].project_name}", 
                     styles['Title'])
    story.append(title)
    story.append(Spacer(1, 0.3*inch))
    
    # Metadata
    meta = Paragraph(f"Generated: {data['generated_date'].strftime('%B %d, %Y')}<br/>"
                    f"Generated By: {data['generated_by']}", 
                    styles['Normal'])
    story.append(meta)
    story.append(Spacer(1, 0.5*inch))
    
    # Project Details Section
    story.append(Paragraph("<b>PROJECT DETAILS</b>", styles['Heading1']))
    story.append(Spacer(1, 0.1*inch))
    
    project_details = [
        ['Project Name:', data['project'].project_name],
        ['Location:', data['project'].location or 'N/A'],
        ['Project Status:', data['project'].project_status or 'N/A'],
        ['Licensing Approach:', data['project'].licensing_approach or 'N/A'],
        ['Commercial Operation:', data['project'].cod.strftime('%B %Y') if data['project'].cod else 'TBD'],
        ['MPR Project ID:', data['project'].mpr_project_id or 'N/A'],
    ]
    
    t = Table(project_details, colWidths=[2*inch, 4*inch])
    story.append(t)
    story.append(Spacer(1, 0.3*inch))
    
    # Financial Data Section (if accessible)
    if any(v != '[Confidential]' for v in data['financial'].values()):
        story.append(Paragraph("<b>FINANCIAL DATA</b>", styles['Heading1']))
        story.append(Spacer(1, 0.1*inch))
        
        financial_details = [
            ['CAPEX:', f"${data['financial']['capex']:,.0f}" if data['financial']['capex'] != '[Confidential]' else '[Confidential]'],
            ['OPEX:', f"${data['financial']['opex']:,.0f}/year" if data['financial']['opex'] != '[Confidential]' else '[Confidential]'],
            ['Fuel Cost:', f"${data['financial']['fuel_cost']:,.0f}/year" if data['financial']['fuel_cost'] != '[Confidential]' else '[Confidential]'],
            ['LCOE:', f"${data['financial']['lcoe']:,.2f}/MWh" if data['financial']['lcoe'] != '[Confidential]' else '[Confidential]'],
        ]
        
        t = Table(financial_details, colWidths=[2*inch, 4*inch])
        story.append(t)
        story.append(Spacer(1, 0.3*inch))
    
    # Stakeholders Section
    story.append(Paragraph("<b>STAKEHOLDERS</b>", styles['Heading1']))
    story.append(Spacer(1, 0.1*inch))
    
    # Add vendors, constructors, operators, owners...
    # [Implementation details...]
    
    # Add watermark if report contains confidential data
    if data['include_confidential'] and get_system_setting('confidential_watermark_enabled', 'true') == 'true':
        add_watermark(doc, get_system_setting('confidential_watermark_text', 'CONFIDENTIAL'))
    
    # Build PDF
    doc.build(story)
    
    # Return as download
    buffer.seek(0)
    filename = f"Project_Summary_{data['project'].project_name}_{datetime.now().strftime('%Y%m%d')}.pdf"
    return send_file(buffer, 
                    mimetype='application/pdf',
                    as_attachment=True,
                    download_name=filename)
```

---

## Technology Vendor Profile

### Purpose
Deep dive into a vendor with products, relationships, and market presence

### Report Structure

```
═══════════════════════════════════════════════════════════
[COMPANY LOGO]      TECHNOLOGY VENDOR PROFILE
                        TechVendor X
                    
                    Generated: Dec 4, 2025
                    Generated By: John Smith
═══════════════════════════════════════════════════════════

VENDOR OVERVIEW
───────────────────────────────────────────────────────────
Vendor Name:            TechVendor X
Status:                 Active
Primary Focus:          Small Modular Reactors

PRODUCTS & TECHNOLOGIES
───────────────────────────────────────────────────────────
Xe-100 SMR
  Reactor Type:         Pressurized Water Reactor (PWR)
  Thermal Capacity:     200 MWth (77 MWe)
  Thermal Efficiency:   35.5%
  Burnup:               60 GWd/MTU
  Design Status:        NRC Licensed
  Notes:                Advanced passive safety features...

Xe-200 SMR
  Reactor Type:         Pressurized Water Reactor (PWR)
  Thermal Capacity:     400 MWth (154 MWe)
  Design Status:        Conceptual Design
  Notes:                Scaled version of Xe-100...

MARKET PRESENCE
───────────────────────────────────────────────────────────
Active Projects:        5
Owners/Developers:      8 relationships
  - 3 MOUs
  - 3 Development Agreements
  - 2 Delivery Contracts

PROJECT DEPLOYMENTS
───────────────────────────────────────────────────────────
Project Name        Owner/Developer      Status        Technology
────────────────────────────────────────────────────────────
Project Alpha       ClientCo Energy      Active        Xe-100
Project Beta        UtilityCo            Planning      Xe-100
Project Gamma       PowerGen Inc         Design        Xe-100

RELATIONSHIPS
───────────────────────────────────────────────────────────
Owners/Developers with Agreements:
  • ClientCo Energy - Delivery Contract (signed 2024-06-20)
    2-unit deployment at Project Alpha site
  
  • UtilityCo - Development Agreement (signed 2024-03-15)
    Evaluating 4-unit deployment
  
  • PowerGen Inc - MOU (signed 2023-11-01)
    Initial feasibility study phase

[Note: 2 confidential relationships omitted]

Preferred Constructors:
  • BuildCorp Construction
    Preferred due to SMR construction experience
  
  [1 confidential relationship omitted]

Supplier Relationships:
  [All supplier relationships are confidential]

KEY PERSONNEL
───────────────────────────────────────────────────────────
Name                Role              Contact
────────────────────────────────────────────────────────────
Dr. Jane Doe        CEO               jane@techvendorx.com
John Smith          CTO               john@techvendorx.com
Sarah Johnson       VP Sales          sarah@techvendorx.com

NOTES
───────────────────────────────────────────────────────────
TechVendor X is a leading developer of small modular reactor
technology with significant backing from major energy 
investors...

═══════════════════════════════════════════════════════════
                        Page 1 of 2

This report respects data confidentiality settings.
Some information may be omitted based on user permissions.
═══════════════════════════════════════════════════════════
```

---

## Relationship Map Report

### Purpose
Visual and textual representation of entity relationships

### Report Structure

```
═══════════════════════════════════════════════════════════
[COMPANY LOGO]       RELATIONSHIP MAP REPORT
                    
                    Generated: Dec 4, 2025
                    Generated By: John Smith
═══════════════════════════════════════════════════════════

REPORT PARAMETERS
───────────────────────────────────────────────────────────
Focus Entity:           All Entities
Entity Types:           Vendors, Projects, Owners, Constructors
Relationship Types:     All
Depth:                  All
Confidential Data:      Included

NETWORK STATISTICS
───────────────────────────────────────────────────────────
Total Entities:         68
  - Vendors:            18
  - Owners:             27
  - Projects:           15
  - Constructors:       8
  - Operators:          5

Total Relationships:    142
  - Public:             98
  - Confidential:       44 (visible to authorized users)

NETWORK DIAGRAM
───────────────────────────────────────────────────────────
[Static PNG/SVG image of network diagram embedded here]

Legend:
  ○ Technology Vendor
  □ Owner/Developer
  ◇ Project
  △ Constructor
  ▽ Operator
  
  ─── Public Relationship
  
Note: Confidential relationships not shown if user lacks access

RELATIONSHIP DETAILS
───────────────────────────────────────────────────────────

TECHNOLOGY DEPLOYMENTS (15 relationships)
  Project Alpha → TechVendor X (Technology: Xe-100)
  Project Beta → TechVendor Y (Technology: BWRX-300)
  Project Gamma → TechVendor X (Technology: Xe-100)
  ...

OWNER-VENDOR AGREEMENTS (24 relationships)
  ClientCo Energy ↔ TechVendor X (Delivery Contract - 2024-06-20)
  UtilityCo ↔ TechVendor Y (Development Agreement - 2024-03-15)
  PowerGen Inc ↔ TechVendor X (MOU - 2023-11-01)
  ...

CONSTRUCTION RELATIONSHIPS (18 relationships)
  Project Alpha → BuildCorp Construction (Primary Contractor)
  Project Beta → ConstructCo LLC (Primary Contractor)
  ...

ENTITY SUMMARIES
───────────────────────────────────────────────────────────

TechVendor X (Technology Vendor)
  Relationships: 12
  Connected to: ClientCo Energy, UtilityCo, PowerGen Inc,
                Project Alpha, Project Gamma, BuildCorp Construction
  Key Details: 2 products (Xe-100, Xe-200), 5 active projects

ClientCo Energy (Owner/Developer)
  Relationships: 8
  Connected to: TechVendor X, Project Alpha, BuildCorp Construction
  Key Details: IOU, Invested engagement level, 1 active project

[Additional entity summaries...]

═══════════════════════════════════════════════════════════
                        Page 1 of 3

Confidential relationships are excluded from this view
for users without appropriate access.
═══════════════════════════════════════════════════════════
```

---

## PDF Generation Technical

### Technology Choice

**Recommended: WeasyPrint**
- HTML/CSS to PDF conversion
- Easier to style and maintain
- Good support for headers/footers, page numbers
- Handles complex layouts well

**Alternative: ReportLab**
- Programmatic PDF generation
- More control over exact positioning
- Steeper learning curve

### Common Report Elements

**Header Template:**
```python
def create_report_header(canvas, doc, logo_path=None):
    """Add header to each page"""
    canvas.saveState()
    
    # Add logo if configured
    if logo_path:
        canvas.drawImage(logo_path, 0.5*inch, doc.height + 1.5*inch, 
                        width=2*inch, height=0.5*inch, 
                        preserveAspectRatio=True)
    
    # Add report title
    canvas.setFont('Helvetica-Bold', 16)
    canvas.drawCentredString(doc.width/2 + inch, doc.height + 1.5*inch, 
                            "PROJECT SUMMARY REPORT")
    
    canvas.restoreState()
```

**Footer Template:**
```python
def create_report_footer(canvas, doc):
    """Add footer to each page"""
    canvas.saveState()
    
    # Page number
    page_num = canvas.getPageNumber()
    canvas.setFont('Helvetica', 9)
    canvas.drawCentredString(doc.width/2 + inch, 0.5*inch, 
                            f"Page {page_num}")
    
    # Confidentiality notice
    canvas.drawCentredString(doc.width/2 + inch, 0.3*inch,
                            "This report respects data confidentiality settings.")
    
    canvas.restoreState()
```

**Watermark:**
```python
def add_watermark(canvas, doc, text="CONFIDENTIAL"):
    """Add diagonal watermark across page"""
    canvas.saveState()
    
    # Semi-transparent gray
    canvas.setFillColorRGB(0.7, 0.7, 0.7, alpha=0.3)
    canvas.setFont('Helvetica-Bold', 72)
    
    # Rotate and center
    canvas.translate(doc.width/2, doc.height/2)
    canvas.rotate(45)
    canvas.drawCentredString(0, 0, text)
    
    canvas.restoreState()
```

### Confidentiality Filtering Logic

```python
def filter_report_data(user, data):
    """Filter report data based on user permissions"""
    filtered = {}
    
    # Filter fields
    for entity in data['entities']:
        filtered_entity = {}
        for field, value in entity.items():
            if can_view_field(user, entity['__tablename__'], entity['id'], field):
                filtered_entity[field] = value
            else:
                filtered_entity[field] = '[Confidential]'
        filtered['entities'].append(filtered_entity)
    
    # Filter relationships
    filtered['relationships'] = [
        rel for rel in data['relationships']
        if can_view_relationship(user, rel)
    ]
    
    # Count hidden items
    filtered['hidden_count'] = len(data['relationships']) - len(filtered['relationships'])
    
    return filtered
```

---

## Excel Export

### Purpose
Alternative format for data analysis and manipulation

### Structure

**Multi-sheet workbook:**
- Sheet 1: Main entity data
- Sheet 2: Relationships
- Sheet 3: Personnel
- Sheet 4: Financial data (if accessible)
- Sheet 5: Metadata (generation info, parameters)

### Implementation

```python
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment

def generate_project_summary_excel(data):
    """Generate Excel version of Project Summary Report"""
    wb = Workbook()
    
    # Sheet 1: Project Details
    ws1 = wb.active
    ws1.title = "Project Details"
    
    # Header row
    ws1['A1'] = "Project Summary Report"
    ws1['A1'].font = Font(size=16, bold=True)
    ws1['A2'] = f"Generated: {data['generated_date'].strftime('%Y-%m-%d')}"
    ws1['A3'] = f"Generated By: {data['generated_by']}"
    
    # Project info
    row = 5
    ws1[f'A{row}'] = "Field"
    ws1[f'B{row}'] = "Value"
    ws1[f'A{row}'].font = Font(bold=True)
    ws1[f'B{row}'].font = Font(bold=True)
    
    row += 1
    fields = [
        ('Project Name', data['project'].project_name),
        ('Location', data['project'].location),
        ('Status', data['project'].project_status),
        ('Licensing', data['project'].licensing_approach),
        ('COD', data['project'].cod),
    ]
    
    for field, value in fields:
        ws1[f'A{row}'] = field
        ws1[f'B{row}'] = value
        row += 1
    
    # Sheet 2: Financial Data
    if any(v != '[Confidential]' for v in data['financial'].values()):
        ws2 = wb.create_sheet("Financial Data")
        ws2['A1'] = "Financial Information"
        ws2['A1'].font = Font(size=14, bold=True)
        
        row = 3
        for field, value in data['financial'].items():
            ws2[f'A{row}'] = field.upper()
            ws2[f'B{row}'] = value if value != '[Confidential]' else 'CONFIDENTIAL'
            if value == '[Confidential]':
                ws2[f'B{row}'].fill = PatternFill(start_color='FFCCCC', fill_type='solid')
            row += 1
    
    # Sheet 3: Relationships
    ws3 = wb.create_sheet("Relationships")
    ws3['A1'] = "Project Relationships"
    ws3['A1'].font = Font(size=14, bold=True)
    
    # Headers
    row = 3
    headers = ['Type', 'Entity', 'Details', 'Confidential']
    for col, header in enumerate(headers, start=1):
        ws3.cell(row=row, column=col, value=header).font = Font(bold=True)
    
    row += 1
    for rel_type, entities in [
        ('Vendor', data['vendors']),
        ('Constructor', data['constructors']),
        ('Operator', data['operators']),
        ('Owner', data['owners'])
    ]:
        for entity in entities:
            ws3.cell(row=row, column=1, value=rel_type)
            ws3.cell(row=row, column=2, value=entity['name'])
            ws3.cell(row=row, column=3, value=entity.get('details', ''))
            ws3.cell(row=row, column=4, value='Yes' if entity.get('is_confidential') else 'No')
            row += 1
    
    # Save to buffer
    from io import BytesIO
    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)
    
    filename = f"Project_Summary_{data['project'].project_name}_{datetime.now().strftime('%Y%m%d')}.xlsx"
    return send_file(buffer,
                    mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    as_attachment=True,
                    download_name=filename)
```

---

## Summary

### Report Features

1. ✅ **Three PDF Reports** - Project Summary, Vendor Profile, Relationship Map
2. ✅ **Automatic Confidentiality Filtering** - Based on user permissions
3. ✅ **Professional Formatting** - Company logo, headers, footers
4. ✅ **Confidential Watermark** - On reports with restricted data
5. ✅ **Excel Export** - Alternative format for all reports
6. ✅ **Clear Disclosure** - Notes indicating omitted confidential data

### Key Principles

- **Respect permissions** - Never show restricted data
- **Clear indicators** - "[Confidential]" or "X items omitted"
- **Professional appearance** - Consistent branding and formatting
- **Useful for analysis** - Excel format for data manipulation

### Next Steps

1. Implement PDF generation with ReportLab or WeasyPrint
2. Create report templates
3. Test confidentiality filtering thoroughly
4. Add report generation to UI
5. Implement Excel export functionality

---

**Document End**